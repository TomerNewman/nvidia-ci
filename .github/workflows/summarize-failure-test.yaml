name: Test AI Summary Locally

on:
  workflow_dispatch:

jobs:
  test-summary:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('workflows/summarize-requirements.txt') }}


      - name: Cache Hugging Face model
        uses: actions/cache@v4
        with:
          path: ~/.cache/huggingface
          key: hf-models-${{ runner.os }}-distilbart-cnn


      - name: Install summarizer dependencies
        run: pip install -r workflows/summarize-requirements.txt

      - name: Download failed prow log
        run: |
          LOG_URL="https://gcsweb-ci.apps.ci.l2s4.p1.openshiftapps.com/gcs/test-platform-results/pr-logs/pull/rh-ecosystem-edge_nvidia-ci/262/pull-ci-rh-ecosystem-edge-nvidia-ci-main-4.19-stable-nvidia-gpu-operator-e2e-master/1953346203395559424/build-log.txt"
          echo "Downloading: $LOG_URL"
          curl -s "$LOG_URL" -o log.txt

      - name: Filter log for errors
        run: |
          echo "Filtering error lines..."
          grep -iE 'fail|error|panic|exception' log.txt | tail -n 100 > filtered-log.txt || echo "No error lines found."
          cat filtered-log.txt

      - name: Run summarizer on filtered log
        run: |
          python3 workflows/summarize.py filtered-log.txt --model sshleifer/distilbart-cnn-12-6 > summary.txt
          echo "AI Summary:"
          cat summary.txt

      - name: Comment on PR #1 in your fork
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('summary.txt', 'utf8');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: 1,
              body: `**AI Summary for Failed Job**\n\n\`\`\`\n${summary}\n\`\`\`\n[ Full log](https://gcsweb-ci.apps.ci.l2s4.p1.openshiftapps.com/gcs/test-platform-results/pr-logs/pull/rh-ecosystem-edge_nvidia-ci/262/pull-ci-rh-ecosystem-edge-nvidia-ci-main-4.19-stable-nvidia-gpu-operator-e2e-master/1953346203395559424/build-log.txt)`
            });
